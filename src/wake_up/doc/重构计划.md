# Wake Up 模块重构计划

## 当前代码结构分析

### 概述
当前 `wake_up` 模块集成了多种功能：
- 语音唤醒（Wake Word Detection）
- 声纹识别（Voice Print Recognition）
- ROS 通信（发布唤醒消息）

目标是将其重构为只包含唤醒功能的 SDK 库（.so），可以被其他应用集成使用。

### 主要文件分析

#### 1. CMakeLists.txt
已经进行了部分修改，移除了：
- ROS 相关依赖（ament_cmake, rclcpp 等）
- Python 和 pybind11 相关依赖（声纹识别部分）
- gperftools 性能分析工具依赖

保留了：
- nlohmann_json 依赖（用于解析 JSON 数据）
- 基本的 C++ 编译选项
- 路径配置（资源路径、库路径等）

#### 2. 核心代码文件
- **who_says_what.cpp/hpp**：主程序入口，包含 ROS 节点、声纹识别和唤醒功能
- **ivw.cpp**：唤醒功能核心实现
- **audio_buffer.cpp/h**：音频缓冲区管理
- **speech_recognizer.cpp/h**：语音识别相关功能
- **linuxrec.c/h**：Linux 录音功能实现

#### 3. 依赖分析
- **外部依赖**：
  - aikit 库（唤醒功能的底层实现）
  - asound 库（ALSA，音频捕获）
  - sndfile 库（音频文件处理）
  - nlohmann_json 库（JSON 解析）
  - ~~ROS 相关库（已移除）~~
  - ~~Python/pybind11（已移除，用于声纹识别）~~

- **内部依赖**：
  - 唤醒功能依赖于音频缓冲区和音频捕获功能
  - 原 ROS 通信依赖于唤醒功能的输出

## 重构计划

### 1. 库结构设计

将唤醒功能封装为一个 C++ 类库，对外提供简洁的 API：

```cpp
class WakeUpDetector {
public:
    // 构造函数，可设置资源路径、关键词等
    WakeUpDetector(const std::string& resource_path, const std::string& keyword_file = "");
    ~WakeUpDetector();

    // 回调函数类型定义
    using WakeUpCallback = std::function<void(const std::string& keyword, int confidence)>;
    
    // 设置唤醒回调
    void setWakeUpCallback(WakeUpCallback callback);
    
    // 启动唤醒检测（从麦克风）
    bool start();
    
    // 停止唤醒检测
    bool stop();
    
    // 处理外部音频数据（用于从外部提供音频数据）
    bool processAudio(const int16_t* audio_data, size_t length);
    
    // 获取当前状态
    bool isRunning() const;

private:
    // 内部实现细节
};
```

### 2. 重构步骤

#### 步骤一：移除 ROS 和声纹识别相关代码
1. 删除 who_says_what.hpp/cpp 中 ROS 和声纹识别相关的代码
2. 创建新的 wake_up_detector.hpp/cpp 作为新的 API 入口

#### 步骤二：重组核心功能
1. 保留 ivw.cpp 中的唤醒功能核心代码
2. 重构为面向对象的 API 设计
3. 保留音频缓冲区功能，用于音频数据处理

#### 步骤三：修改 CMakeLists.txt 生成共享库
1. 将 add_executable 修改为 add_library，生成共享库
2. 配置正确的安装路径和头文件导出

#### 步骤四：新增 SDK 演示程序
1. 创建一个简单的测试程序，展示如何使用新的库
2. 提供编译和使用说明

### 3. 具体实现计划

#### 新文件结构
```
wake_up/
  ├── include/
  │   ├── wake_up/
  │   │   ├── wake_up_detector.h     # 新的 API 头文件
  │   │   ├── audio_buffer.h         # 保留
  │   │   └── internal/              # 内部实现细节
  │   │       ├── speech_recognizer.h
  │   │       └── linuxrec.h
  │   └── config.h.in                # 配置头文件
  ├── src/
  │   ├── wake_up_detector.cpp       # 新的 API 实现
  │   ├── audio_buffer.cpp           # 保留
  │   ├── ivw_impl.cpp               # 从 ivw.cpp 重构
  │   ├── speech_recognizer.cpp      # 保留
  │   └── linuxrec.c                 # 保留
  ├── example/
  │   └── wake_up_demo.cpp           # 示例程序
  ├── CMakeLists.txt                 # 修改为生成共享库
  ├── resource/                      # 资源文件
  └── libs/                          # 依赖库
```

#### CMakeLists.txt 修改要点
```cmake
# 生成共享库
add_library(wake_up SHARED
  src/wake_up_detector.cpp
  src/audio_buffer.cpp
  src/ivw_impl.cpp
  src/speech_recognizer.cpp
  src/linuxrec.c
)

# 设置版本号和 soname
set_target_properties(wake_up PROPERTIES
  VERSION 1.0.0
  SOVERSION 1
)

# 安装目标
install(TARGETS wake_up
  LIBRARY DESTINATION lib
)

# 安装头文件
install(DIRECTORY include/wake_up
  DESTINATION include
)

# 构建示例程序
add_executable(wake_up_demo example/wake_up_demo.cpp)
target_link_libraries(wake_up_demo wake_up)
```

## 注意事项与风险

1. **API 兼容性**：
   - 需确保新的 API 设计合理，便于集成
   - 考虑提供 C 接口以支持更多语言绑定

2. **资源管理**：
   - 确保正确释放资源，避免内存泄漏
   - 合理处理异常情况

3. **多线程安全**：
   - 音频处理和回调需要考虑线程安全
   - 避免死锁和竞态条件

4. **依赖管理**：
   - 明确外部依赖要求，便于集成方解决依赖问题
   - 考虑是否需要静态链接某些库以减少外部依赖

5. **测试**：
   - 确保重构后的功能与原有功能一致
   - 编写单元测试和集成测试

## 后续优化方向

1. **性能优化**：
   - 优化音频处理逻辑，减少 CPU 占用
   - 考虑使用更高效的算法和数据结构

2. **资源占用**：
   - 优化内存使用，避免不必要的拷贝
   - 适当降低采样率或精度以减少资源占用

3. **跨平台支持**：
   - 考虑添加 Windows/macOS 支持
   - 抽象平台相关代码

4. **文档完善**：
   - 编写详细的 API 文档
   - 提供集成指南和示例代码 